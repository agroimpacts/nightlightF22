---
title: "nightlights_boston"
author: "Lester Carver"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nightlights_boston}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, warnings = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(terra)
library(dplyr)
library(sf)
library(ggplot2)
library(here)
library(tidyr)
```
# Introduction



## Datasets

We will be using the following datasets for our analysis:

- A set of images representing the time series of monthly night lights data over Boston covering the period 2012-2021, as well as the monthly average over the period and the average of each month during the 10 year period This data comes from the VNP46A3 - VIIRS Monthly Nighttime Lights, which are a part of NASA’s Black Marble Nighttime Lights Product Suite.  
- Vector file of public housing locations in Boston
- Gridded data of the proportion of public housing across Boston
- Census tracts for Boston
- Gridded population of Boston
- Building footprints for Boston
- Gridded data of the square meters of buildings in Boston, used to approximate living space

```{r}
# Boston Census tracts & outline
bstntract <- readRDS(here("data/bstn_tract.rds"))
bstn <- readRDS(here("data/bstn.rds"))

# Boston public housing developments & grid
bstn_ph <- readRDS(here("data/bstn_phpoly.rds"))
bstn_ph_grid <- rast(here("data/bstn_ph_coverage.tif"))[[1]]

# Boston buildings & grid
bstn_bldg_grid <- rast(here("data/bstn_bldg_grid.tif"))
bstn_bldg <- readRDS(here("data/bstn_bldg.rds"))

# Boston population grid
bstn_pop <- rast(here("data/bstn_pop.tif"))[[1]]

# Nightlights data, monthly, average for each month over 10 years, 10 year mean
nlights <- rast(here("data/Boston_nightlights.tif"))
nlight_mo <- rast(here("data/Boston_nightlights_mean_month.tif"))
nlight_lt <- rast(here("data/Boston_nightlights_mean.tif"))
names(nlight_lt) <- "brightness"
nl_dates <- readRDS(here("data/Boston_nightlight_dates.rds"))
```

# Public Housing 

```{r, echo=FALSE, eval=FALSE}
phplt <- ggplot() +
  geom_sf(data = bstntract, col = alpha("grey7", 0.3), fill = "grey") +
  geom_sf(data = bstn_ph, aes(fill = ''), col = "red", 
          show.legend = "polygon") +
  labs(fill = "Public Housing Developments") + 
  theme(legend.position = c(0.2, 0.9)) 
ggsave(phplt, file = here("vignettes/figures/bstn_housing.png"), 
       height = 7, width = 10, dpi = 72)
```

The map below shows Boston's public housing developments, a total of 53 developments.

```{r, echo=FALSE}
knitr::include_graphics(here("vignettes/figures/bstn_housing.png"))
```

In order to compare areas with similar building structure and populations with and without public housing, we will use the gridded public housing coverage data combined with the gridded datasets for population and estimated square meters of buildings in Boston, which provides an estimate of the living space and structure of the city's built environment.

```{r, fig.height=4, fig.width=7}
rs <- c(bstn_ph_grid * 100, bstn_bldg_grid$area_sqm, bstn_pop, mask(nlight_lt, bstn_pop))
names(rs) <- c("ph", "area_sqm", "population", 
               "radiance")
par(oma=c(0,0,0,3))
plot(rs, nc = 2, axes = FALSE,
     main = c("% Public housing", "Building Area (SqM)", "Population", 
              "Nighttime radiance"))
```


# Nightlights

```{r, echo=FALSE}
nlplt <- ggplot(as.data.frame(nlight_lt, xy = TRUE)) + 
  geom_raster(aes(x = x, y = y, fill = brightness)) +
  geom_sf(data = bstntract %>% st_transform(crs = 4326), fill = "transparent", 
          col = "yellow", size = 0.2) +
  scale_fill_distiller(
    guide = guide_colorbar(ticks = FALSE),
    type = "seq", direction = -1, palette = "Greys"
  ) + xlab('') + ylab('') + theme_void()
```

The image below is the average monthly brightness of Boston nightlights between the years 2012 - and 2021. 

```{r, echo=FALSE, fig.height=5, fig.width=7}
nlplt
```
 

# Analysis

### What is the relationship between public housing and brightness?
To first see if there is any relationship between public housing and nighttime lighting overall in Boston, we start with a linear regression to compare the change in radiance against increasing percentages of public housing in each nightlights pixel. 

```{r, message=FALSE, fig.width=7}
dat <- as_tibble(as.data.frame(rs, cells = TRUE)) %>% na.omit(.)
dat %>% filter(ph > 0) %>% 
  ggplot() + geom_point(aes(x = ph, y = radiance)) + 
  geom_smooth(aes(x = ph, y = radiance), method = "lm") + 
  xlab("% public housing") + ylab("Radiance in nWatts·cm−2·sr−1")
```

The plot shows a large amount of variability, but an overall increase in brightness as the proportion of public housing in a grid cell increases. However, the regression does not account for differences in the building structures and population across the city that might be influencing factors on nighttime radiance. To see whether areas with public housing are more brightly lit than areas without public housing, we need to control for population and building square meters.  

### Comparing areas with similar structure and population

Ideally, we would compare similar areas based on pixel percentage of public housing, building structure, and population. However, our public housing grid shows that there is only a very small range of percentage of public housing across Boston (0-3.5%) so we will just group like areas in terms of building structure and population and compare just those groupings that have public housing and that don't.

To group pixels with and without public housing in them according to levels defined by differing percentiles of building volume and population, we first create a cross-tabulation of the quantiles for both population and building area.

```{r}
# Get quantiles of population and building volume in pixels with public housing
pop_quantiles <- dat %>% filter(ph > 0) %>% 
  pull(population) %>% quantile(.)
area_quantiles <- dat %>% pull(area_sqm) %>% quantile(.)

# Assign quantile to each cell with public housing
poparea <- dat %>% filter(ph > 0) %>% 
  mutate(., pop_class = cut(population, pop_quantiles, include.lowest = TRUE, dig.lab = 4)) %>% 
  mutate(., barea_class = cut(area_sqm, area_quantiles, include.lowest = TRUE, dig.lab = 6))

# Create new table with quantiles of pop and area as x & y
# showing count of each pixel for each combination of quantiles
# Drop () & [] special characters from each column
ctab <- table(pop = poparea$pop_class, barea = poparea$barea_class) %>% 
  as.data.frame(.) %>% 
  separate(., col = pop, into = c("pop_lower", "pop_upper"), sep = ",") %>% 
  separate(., col = barea, into = c("barea_lower", "barea_upper"), sep = ",") %>%
  mutate(., pop_lower = as.numeric(gsub('\\[|\\(', '', pop_lower))) %>% 
  mutate(., pop_upper = as.numeric(gsub("\\]|\\)", "", pop_upper))) %>%
  mutate(., barea_lower = as.numeric(gsub("\\(|\\[", "", barea_lower))) %>%
  mutate(., barea_upper = as.numeric(gsub("\\]|\\)", "", barea_upper))) %>%
  filter(., Freq > 1)
```

Now, we will group pixels with and without public housing into the combination of population and building area quantiles.
```{r}
# Select pixels with no public housing within the different combination
# of population and building area quantiles
no_ph_dat <- lapply(1:nrow(ctab), function(x) {   # x <- 1
  l <- ctab[x, ]
  dat %>% filter(ph == 0) %>% 
    filter(between(population, l$pop_lower, l$pop_upper)) %>% 
    filter(between(area_sqm, l$barea_lower, l$barea_upper)) %>% 
    mutate(Level = factor(x), Group = "No public housing")
}) %>% bind_rows()

# Select pixels with public housing into the same categories 
ph_dat <- lapply(1:nrow(ctab), function(x) {   # x <- 1
  l <- ctab[x, ]
  dat %>% filter(ph > 0) %>% 
    filter(between(population, l$pop_lower, l$pop_upper)) %>% 
    filter(between(area_sqm, l$barea_lower, l$barea_upper)) %>% 
    mutate(Level = factor(x), Group = "Public housing")
  }) %>% bind_rows()

# combine into single table 
combined <- bind_rows(ph_dat, no_ph_dat)
```

Having prepared the data, we can now look at the differences using box plots to compare the differences between pixels with public housing to those that don't, grouped according to the population and building volume levels

```{r, fig.width=7}
p <- ggplot(combined) + 
  geom_boxplot(aes(x = Level, y = radiance, fill = Group)) +
  scale_color_manual(values = c('red', 'blue')) +
  scale_fill_manual(values = alpha(c('red', 'blue'), 0.3)) +
  xlab("Population/Building Area Class") + ylab("Radiance in nWatts·cm−2·sr−1") +
  theme_linedraw() #+
p
```
We can see in the box plots that 7 of the 11 population/building area classes show pixels containing public housing are more brightly lit than those without public housing.Let's calculate the averages:

```{r, message=FALSE}
rad_stats <- combined %>%
  group_by(Group, Level) %>% 
  summarize(Radiance = median(radiance)) %>% ungroup() %>% 
  pivot_wider(names_from = Group, values_from = Radiance) %>% 
  mutate(Difference = `Public housing` - `No public housing`)

knitr::kable(rad_stats, digits = 0)
```

That compares the median difference between the two groups at each level, which shows some large brightness differences in each category.
